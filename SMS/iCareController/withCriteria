package com.iCareapi.sms;

import jakarta.servlet.http.HttpServletRequest;
import org.json.JSONException;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.Arrays;
import java.util.List;

import java.lang.reflect.Field;
import java.util.Map;

@RestController
@RequestMapping(path = "/outgoing")
public class iCareController {
    private final iCareService icareService;

    public iCareController(iCareService icareService) {
        this.icareService = icareService;
    }

    @CrossOrigin()
    @PostMapping(value = "/send", produces = MediaType.APPLICATION_JSON_VALUE)
    public ResponseEntity<String> handleRequest(HttpServletRequest request,
                                                @RequestParam(name = "action") String action,
                                                @RequestParam(name = "patientPhoneNo", required = false) String patientPhoneNo,
                                                @RequestParam(name = "providerPhoneNo", required = false) String providerPhoneNo,
                                                @RequestParam(name = "userPhoneNo", required = false) String userPhoneNo,
                                                @RequestParam(name = "criteria", required = false) String criteria,
                                                @RequestParam(name = "status", required = false) String status,
                                                @RequestParam(name = "message", required = false) String message
//    ) throws JSONException {
//        if (iCareConfig.ACTION_OUTGOING.equals(action)){
//            SMSRequestPayload payload = new SMSRequestPayload();
//            payload.setPatientPhoneNo(patientPhoneNo);
//            payload.setProviderPhoneNo(providerPhoneNo);
//            payload.setUserPhoneNo(userPhoneNo);
//            payload.setStatus(status);
//            payload.setMessage(message);
//            icareService.processSMSRequest(payload);
//        }
//        return new ResponseEntity<>("SMS sent successfully.",HttpStatus.OK);
// }
//

    ) throws JSONException {
        if (iCareConfig.ACTION_OUTGOING.equals(action)) {
            SMSRequestPayload payload = new SMSRequestPayload();
            payload.setPatientPhoneNo(patientPhoneNo);
            payload.setProviderPhoneNo(providerPhoneNo);
            payload.setUserPhoneNo(userPhoneNo);
            payload.setCriteria(criteria);
            payload.setStatus(status);
            payload.setMessage(message);

            // Check if the criteria matches any of the phone numbers
            String result = checkCriteria(criteria, payload);

            icareService.processSMSRequest(payload);

            return new ResponseEntity<>(result, HttpStatus.OK);
        }

        return new ResponseEntity<>("Invalid action.", HttpStatus.BAD_REQUEST);
    }

    private String checkCriteria(String criteria, SMSRequestPayload payload) {
        if (criteria == null || criteria.isEmpty()) {
            return "No criteria specified.";
        }

        if ("patientPhoneNo".equals(criteria) && payload.getPatientPhoneNo() != null) {
            return "Criteria matched with patient's phone number.";
        }

        if ("providerPhoneNo".equals(criteria) && payload.getProviderPhoneNo() != null) {
            return "Criteria matched with provider's phone number.";
        }

        if ("userPhoneNo".equals(criteria) && payload.getUserPhoneNo() != null) {
            return "Criteria matched with user's phone number.";
        }

        return "No match.";
    }

}
